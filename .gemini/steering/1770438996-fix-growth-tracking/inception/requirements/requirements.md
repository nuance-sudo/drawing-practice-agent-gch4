# 成長トラッキングバグ修正 - 要件定義

## Intent Analysis

| 項目 | 内容 |
|------|------|
| **Request Type** | Bug Fix |
| **Scope** | Single Component (`packages/agent/dessin_coaching_agent`) |
| **Complexity** | Moderate |
| **Clarity** | Clear（詳細な分析ドキュメント提供済み） |

---

## 問題の概要

デッサン分析結果の成長トラッキングが常に「初回提出」と判定される問題を解決する。

**現在の症状:**
```json
{
  "growth": {
    "is_first_submission": true,
    "comparison_note": "同一モチーフの過去データがまだありません"
  }
}
```

## 根本原因

| # | 問題 | 原因 | 状態 |
|---|------|------|------|
| 1 | スコープ不一致 | 古いAgent Engineでは`scope={user_id, session_id}`で保存 | ✅ **解決済み**（session_id削除済み） |
| 2 | モチーフフィルタなし | 分析前にメモリ取得するため、モチーフが不明 | 🎯 **今回の対象** |

---

## 機能要件

### FR-1: 処理フロー変更

**Before（現在）:**
```
1. メモリ取得（フィルタなし）← モチーフ不明
2. 画像分析（成長情報含む）
3. メモリ保存
```

**After（新）:**
```
1. 画像分析（成長情報なし or プレースホルダー）
2. 分析結果からモチーフ取得
3. モチーフでフィルタしたメモリ取得
4. メモリが見つからなければ → フォールバック検索（モチーフなし）
5. 成長スコア補正
6. メモリ保存
```

### FR-2: フォールバック検索機能

**検索戦略:**
1. **Step 1**: モチーフでフィルタして検索（例: `motif=りんご`）
2. **Step 2**: 結果が0件 → モチーフフィルタなしで再検索（全履歴）
3. **結果を使って成長比較**

**理由**: 初めてのモチーフでも、他のモチーフでの過去実績があれば成長トラッキングが可能

### FR-3: 成長スコア補正ロジック

| 条件 | is_first_submission | 成長スコア |
|------|---------------------|-----------|
| 過去メモリあり（同一モチーフ） | `false` | 過去スコアと比較して計算 |
| 過去メモリあり（フォールバック） | `false` | 過去スコアと比較して計算 + 注記 |
| 過去メモリなし | `true` | `None` |

---

## 非機能要件

### NFR-1: Agent Engine再デプロイ

- 最新コードを反映し、scopeに`session_id`を含めない設定が有効であることを確認
- 既にデプロイ進行中

### NFR-2: 既存テストの維持

- 既存のテストケースが引き続きパスすること
- 新しい処理フローに対応したテストを追加

---

## 影響範囲

| ファイル | 変更内容 |
|----------|---------|
| `tools.py` | 処理フロー変更（分析後にメモリ取得・補正） |
| `memory_tools.py` | 変更なし（既に`search_memory_by_motif`が存在） |
| `callbacks.py` | 変更なし（既に正しいスコープ設定） |
| `tests/test_memory_tools.py` | 新しい処理フローのテスト追加 |

---

## 検証計画

### 自動テスト
1. 既存テスト実行: `uv run pytest`
2. 新規テスト追加（成長スコア補正ロジック）

### 手動検証
1. 新しいレビューを投稿（例: りんご）
2. Memory Bankで`motif=りんご`のメモリが保存されることを確認
3. 同じモチーフで2回目のレビューを投稿
4. 成長トラッキングが過去データを参照していることを確認
