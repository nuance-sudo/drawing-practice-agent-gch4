# FeedbackService Design

## Architecture
`FeedbackService` will be a standalone service in `packages/agent/src/services/`.

## Service (`packages/agent/src/services/feedback_service.py`)

Methods:
-   `generate_feedback(analysis: DessinAnalysis, rank: Rank) -> FeedbackResponse`:
    -   Takes the raw analysis data and the user's rank.
    -   Generates a structured response including the Markdown content.

## Internal Logic (Markdown Generation)
We will use a template-based approach or a builder pattern to construct the Markdown.

```python
class FeedbackService:
    def generate_feedback(self, analysis: DessinAnalysis, rank: Rank) -> FeedbackResponse:
        # 1. Generate Summary (using existing logic or improved)
        summary = self._create_summary(analysis)
        
        # 2. Generate Detailed Markdown based on Rank
        markdown = self._generate_markdown(analysis, rank)
        
        return FeedbackResponse(
            analysis=analysis,
            summary=summary,
            detailed_feedback=markdown
        )

    def _generate_markdown(self, analysis: DessinAnalysis, rank: Rank) -> str:
        # Construct Markdown string
        # - Header: Score & Rank
        # - Section: Evaluation Radar/Table (represented as text/table)
        # - Section: 4 Criteria Details (Proportion, Tone, Texture, Line)
        #   - Add rank-specific advice text (can be static advice repository based on score/rank)
        # - Section: Next Step / Practice Advice (Rank specific)
        ...
```

## Advice Repository (Simple implementation)
To make it "Rank-Adaptive" without an LLM call:
-   Have a mapping of `(Criteria, Rank, ScoreRange) -> AdviceString`.
-   Or just change the *Header* and *Tone* of the message wrappers.
-   Actually, the `DessinAnalysis` already contains `strengths` and `improvements` lists generated by Gemini. We should leverage those.
-   The "Rank-Adaptive" part can be:
    -   Bronze/Silver: "Great job! Keep practicing [improvement]."
    -   Platinum: "Excellent work. To refine [improvement], consider..."

## Data Models
Existing `packages/agent/src/models/feedback.py`:
-   `DessinAnalysis`
-   `FeedbackResponse`

New:
-   Maybe helper enums or constants for advice templates in the service.

## Integration
In `packages/agent/src/api/reviews.py`:

```python
# ... inside process_review_task ...
rank_service = get_rank_service()
# Update (or get) rank
user_rank = rank_service.update_user_rank(user_id, score, task_id)

# Generate feedback
feedback_service = get_feedback_service()
feedback_response = feedback_service.generate_feedback(analysis, user_rank.current_rank)

# Save to Firestore (Task update)
service.update_task_status(
    task_id,
    TaskStatus.COMPLETED,
    feedback=feedback_response.model_dump(), # Save the full response structure
    score=score,
    tags=analysis.tags,
)
```
*Note*: Currently `TaskService.update_task_status` accepts `feedback` as dict. We will pass the full `FeedbackResponse` dict there.
