# お手本画像生成機能 要求定義書

## 概要

ユーザーのデッサンを分析した結果に基づいて、Gemini 2.5 Flash Image（nano banana）を使用してお手本画像を生成する機能を実装する。

## 背景

現在のシステムでは、デッサン分析とテキストフィードバックは提供されているが、視覚的な改善例が不足している。ユーザーがより具体的に改善点を理解できるよう、AI生成によるお手本画像を提供する。

## 機能要件

### FR-001: お手本画像生成
- **トリガー**: デッサン分析完了後、自動的に画像生成を開始
- **入力**: 
  - 元のデッサン画像
  - 分析結果（改善点、ユーザーランク）
  - モチーフタグ
- **出力**: 改善されたお手本デッサン画像（鉛筆デッサン風）

### FR-002: ランク別お手本生成
- ユーザーの現在ランクの**ワンランク上**のレベルでお手本を生成
- 例：7級ユーザー → 6級レベルのお手本
- 例：初段ユーザー → 2段レベルのお手本

### FR-003: 改善点反映
- 分析で特定された改善点を重点的に反映
- プロポーション、陰影、線の質などの具体的な改善を視覚化

### FR-004: 画像保存・配信
- 生成画像をCloud Storageに保存
- Cloud CDN経由で配信
- ウェブアプリで表示

## ユーザーストーリー

### US-001: お手本画像による学習促進
**役割**: 美術初心者  
**目的**: 改善後のイメージを視覚的に確認したい  
**理由**: テキストだけでは具体的な改善方法が分からないから

**受け入れ条件**:
- [ ] デッサン分析完了後、自動的にお手本画像が生成される
- [ ] お手本画像は自分のランクより1つ上のレベルで生成される
- [ ] 改善点が視覚的に分かりやすく反映されている
- [ ] 鉛筆デッサンの質感・スタイルが維持されている
- [ ] AI生成であることが明記されている

### US-002: 段階的スキルアップ
**役割**: 美術系学生  
**目的**: 次のレベルの目標を明確にしたい  
**理由**: 現在のレベルから次のステップが見えないから

**受け入れ条件**:
- [ ] 現在のランクに応じた適切な難易度のお手本が提供される
- [ ] 無理のない改善レベルで生成される
- [ ] 継続的な練習の指針となる

## 技術要件

### TR-001: Gemini 2.5 Flash Image統合
- Vertex AI経由でgemini-2.5-flash-imageを使用
- 画像生成APIの呼び出し
- エラーハンドリング（生成失敗時の対応）

### TR-002: プロンプト設計
- 鉛筆デッサン特化のプロンプト
- ランク別の難易度調整
- 改善点の具体的な反映

### TR-003: 非同期処理
- 画像生成は時間がかかるため非同期で実行
- タスクステータスの更新
- 完了時の通知

### TR-004: 画像品質
- 1024px解像度での生成
- 鉛筆デッサンの質感維持
- モノクロ表現の保持

## 制約事項

### 制約-001: 生成時間
- 画像生成には平均10秒程度かかる
- 最大3分以内での完了を目標

### 制約-002: 生成成功率
- 95%以上の成功率を目標
- 失敗時はテキストフィードバックのみで完了

### 制約-003: コスト管理
- 月間生成回数の制限を設定
- 必要に応じて生成をスキップする仕組み

## 非機能要件

### NFR-001: パフォーマンス
- 画像生成開始まで5秒以内
- 生成完了まで3分以内
- 失敗時のリトライ機構（最大3回）

### NFR-002: 品質
- 生成画像の一貫性
- 元画像との関連性の維持
- 適切な改善レベルの反映

### NFR-003: 可観測性
- 生成プロセスのログ出力
- 成功/失敗率の監視
- 生成時間の計測

## 実装優先度

| 優先度 | 機能 | 説明 |
|--------|------|------|
| P0 | 基本的な画像生成 | 元画像を基にした改善版の生成 |
| P0 | ランク別調整 | ワンランク上のレベルでの生成 |
| P0 | 画像保存・配信 | Cloud Storage + CDN |
| P1 | 改善点の具体的反映 | 分析結果に基づく詳細な改善 |
| P1 | エラーハンドリング | 生成失敗時の適切な対応 |
| P2 | 生成品質の最適化 | プロンプトの改善・調整 |

## 成功指標

### 定量的指標
- **生成成功率**: 95%以上
- **生成時間**: 平均60秒以内
- **ユーザー満足度**: お手本画像の有用性評価4.0/5.0以上

### 定性的指標
- ユーザーがお手本を参考に実際の改善を実践できる
- 次のレベルの目標が明確になる
- 視覚的な学習効果が向上する