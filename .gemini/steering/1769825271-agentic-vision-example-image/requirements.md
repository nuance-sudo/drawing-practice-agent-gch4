# お手本画像生成へのバウンディング画像統合

## 背景

Gemini 3の新機能「Agentic Vision」を利用して、デッサンの改善ポイントにバウンディングボックスを作成する機能が実装済み。
現在、お手本画像生成時には元画像のみをGemini APIに渡しているが、バウンディング画像（改善ポイントが可視化された画像）も併せて渡すことで、より改善ポイントにフォーカスした修正を行うことができる。

## 参考リンク

- [Gemini 3 Agentic Vision](https://blog.google/innovation-and-ai/technology/developers-tools/agentic-vision-gemini-3-flash/)

## ユーザーストーリー

- ユーザーとして、お手本画像が元画像の改善ポイント（バウンディングボックスで示された箇所）を正確に反映してほしい
- これにより、どの部分をどう修正すべきかがより明確になる

## 現状

1. **annotate_image** Cloud Function:
   - 元画像を分析し、改善ポイントにバウンディングボックスとナンバー付きサークルを描画
   - 結果画像をGCSに保存し、FirestoreのタスクドキュメントにURLを記録

2. **generate_image** Cloud Function:
   - 元画像のみを参照してお手本画像を生成
   - バウンディング画像は使用していない

3. **reviews.py**（Agent API）:
   - アノテーション生成 → お手本画像生成の順で呼び出し
   - お手本画像生成時にアノテーション画像URLを渡していない

## 要求事項

1. **お手本画像生成時にバウンディング画像も渡す**
   - `generate_image` Cloud Functionの入力にアノテーション画像URLを追加
   - Gemini APIに元画像とアノテーション画像の両方を入力として渡す

2. **プロンプトを調整**
   - バウンディングボックスで示された改善ポイントにフォーカスして修正するよう指示

3. **サービス層の更新**
   - `ImageGenerationService`にアノテーション画像URLを渡す引数を追加
   - `reviews.py`でアノテーション完了後のURLをお手本画像生成に渡す

## 制約事項

- アノテーション画像の生成が完了する前にお手本画像生成を開始する場合がある
  - 現在の実装では、アノテーション生成は結果を待たずに次の処理に進む
  - アノテーション完了後のURLを取得するには、アノテーションの完了を待つ必要がある
  - **対策**: アノテーション完了を待ってからお手本画像生成を開始する

## 受け入れ条件

- [ ] `generate_image` Cloud Functionが、元画像とアノテーション画像の両方を入力として受け付ける
- [ ] プロンプトがバウンディングボックスで示された改善ポイントを参照する
- [ ] `ImageGenerationService`がアノテーション画像URLを受け取り、Cloud Functionに渡す
- [ ] `reviews.py`でアノテーション完了を待ってからお手本画像生成を呼び出す
- [ ] 既存のテストが通過し、新しいフローが正常に動作する
